<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Document Viewer</title>
    <link rel="stylesheet" href="./filetree.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <!-- Sidebar -->
    <div id="sidebar">
      <ul id="filetree">
      </ul>
    </div>
    <!-- MarkdownContent -->
    <div id="markdown-content"></div>
    <script src="https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      //Markdown & CSS code
      function processMarkdown(data) {
        var converter = new showdown.Converter();
        const html = converter.makeHtml(data);
        document.getElementById('markdown-content').innerHTML = html;
      }
      
      function applyCss(css) {
        const blob = new Blob([css], { type: 'text/css' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = url;
        document.head.appendChild(link);
      }

      const markdownUrl = urlParams.get('markdown');
      const cssUrl = urlParams.get('css');
      
      if (cssUrl) {
        const xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
            const css = xhr.responseText;
            applyCss(css);
          }
        };
        xhr.open('GET', cssUrl, true);
        xhr.send();
      }
      
      if (markdownUrl) {
        const xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
            processMarkdown(xhr.responseText);
          }
        };
        xhr.open('GET', markdownUrl, true);
        xhr.send();
      }
      //Start of Sidebar code
      function buildFileTree(jsonData, parent) {
        var ul = document.createElement('ul');
        parent.appendChild(ul);

        for (var key in jsonData) {
          var value = jsonData[key];

          if (typeof value === 'object') {
            // Folder
            var li = document.createElement('li');
            var a = document.createElement('a');
            a.textContent = "üìÅ"+key;
            li.appendChild(a);
            ul.appendChild(li);
            buildFileTree(value, li);
          } else {
            // File
            var li = document.createElement('li');
            var a = document.createElement('a');
            a.textContent = "üìÑ"+key;
            a.href = value;
            a.target = '_blank';
            li.appendChild(a);
            ul.appendChild(li);
            
            // Add click event listener to files to redirect to the URL
            a.addEventListener('click', function(e) {
              e.preventDefault();
              window.location.href = this.href;
            });
          }
          
          // Add click event listener to folders to render the sidebar
          if (typeof value === 'object') {
            a.addEventListener('click', function(e) {
              e.preventDefault();
              renderSidebar(value);
            });
          }
        }
      }

      function loadFileTreeFromJson(jsonUrl) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', jsonUrl, true);

        xhr.onload = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
            var jsonData = JSON.parse(xhr.responseText);
            var sidebar = document.getElementById('sidebar');
            buildFileTree(jsonData, sidebar.querySelector('#filetree'));
          }
        };

        xhr.send();
      }
      const queryString2 = window.location.search;
      const urlParams2 = new URLSearchParams(queryString2);
      const json = urlParams2.get('json')
      console.log(json)
      if (json) {
        loadFileTreeFromJson(json);
      }
      //End of Sidebar code
    </script>
  </body>
</html>
